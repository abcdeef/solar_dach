stages:
  - build

build_multi_arch:
  stage: build
  script:
    # QEMU für Multi-Arch Builds aktivieren.
    # Hinweis: Auf Shell-Runnern ist oft kein `sudo` verfügbar.
    # Der folgende Container registriert die benötigten QEMU-Handler im Kernel.

    # Docker Buildx aktivieren
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --use

    # Login bei Docker Hub
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    # Multi-Arch Build & Push
    - docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t $DOCKERHUB_USERNAME/mein-image:latest \
        .

  only:
    - main
