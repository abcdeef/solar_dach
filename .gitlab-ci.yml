stages:
  - build

build_multi_arch:
  stage: build
  tags:
    - docker
  script:
    - command -v docker >/dev/null 2>&1 || { echo "ERROR: 'docker' command not found on this runner. Use a runner with Docker installed (or a Docker executor runner) and tag it with 'docker'."; exit 1; }
    - docker info >/dev/null 2>&1 || { echo "ERROR: Docker is installed but not accessible. Ensure the runner user can access the Docker daemon (e.g. in the 'docker' group) or configure DOCKER_HOST."; exit 1; }

    # QEMU für Multi-Arch Builds aktivieren.
    # Hinweis: Auf Shell-Runnern ist oft kein `sudo` verfügbar.
    # Der folgende Container registriert die benötigten QEMU-Handler im Kernel.

    # Docker Buildx aktivieren
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --use

    # Login bei Docker Hub
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    # Multi-Arch Build & Push
    - docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t $DOCKERHUB_USERNAME/mein-image:latest \
        .

  only:
    - main
