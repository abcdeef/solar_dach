stages:
  - build

build_multi_arch:
  stage: build
  script:
    - command -v docker >/dev/null 2>&1 || { echo "ERROR: 'docker' command not found in the runner environment. If you run gitlab-runner via docker-compose with the *shell* executor, the job runs inside the runner container and needs the Docker CLI there (plus /var/run/docker.sock mounted)."; exit 1; }
    - docker info >/dev/null 2>&1 || { echo "ERROR: Docker CLI found, but cannot talk to the daemon. If using host Docker, mount /var/run/docker.sock into the runner container. Otherwise configure DOCKER_HOST appropriately."; exit 1; }

    # QEMU für Multi-Arch Builds aktivieren.
    # Hinweis: Auf Shell-Runnern ist oft kein `sudo` verfügbar.
    # Der folgende Container registriert die benötigten QEMU-Handler im Kernel.

    # Docker Buildx aktivieren
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    - docker buildx create --use

    # Login bei Docker Hub
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    # Multi-Arch Build & Push
    - docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t $DOCKERHUB_USERNAME/mein-image:latest \
        .

  only:
    - main
